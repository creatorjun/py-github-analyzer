[tox]
envlist = 
    py39
    py310
    py311
    py312
    coverage
    lint
    type-check
    docs
    security

skip_missing_interpreters = True
isolated_build = True

[gh-actions]
python =
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312, coverage, lint, type-check

[testenv]
deps =
    pytest>=7.0.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.0.0
    pytest-mock>=3.10.0
    pytest-xdist>=3.0.0
    httpx>=0.24.0
    aiofiles>=23.0.0
    memory-profiler>=0.60.0
    psutil>=5.9.0

commands =
    # Run unit and integration tests by default
    pytest {posargs:tests/unit tests/integration -v}

[testenv:coverage]
deps =
    {[testenv]deps}
    coverage[toml]>=7.0.0

commands =
    coverage erase
    pytest tests/unit tests/integration --cov=py_github_analyzer --cov-report=html --cov-report=xml --cov-report=term-missing
    coverage report --show-missing --fail-under=85

[testenv:e2e]
deps =
    {[testenv]deps}

commands =
    pytest tests/e2e -v --tb=short -x

[testenv:performance]
deps =
    {[testenv]deps}

commands =
    pytest tests/performance -v --tb=short -k "not slow" --durations=20

[testenv:performance-full]
deps =
    {[testenv]deps}

commands =
    pytest tests/performance -v --tb=short --durations=20

[testenv:lint]
deps =
    black>=23.0.0
    isort>=5.12.0
    flake8>=6.0.0
    flake8-docstrings>=1.7.0
    flake8-type-checking>=2.4.0
    flake8-async>=22.11.14

commands =
    black --check --diff py_github_analyzer tests
    isort --check-only --diff py_github_analyzer tests
    flake8 py_github_analyzer tests

[testenv:format]
deps =
    black>=23.0.0
    isort>=5.12.0

commands =
    black py_github_analyzer tests
    isort py_github_analyzer tests

[testenv:type-check]
deps =
    mypy>=1.5.0
    types-aiofiles>=23.0.0

commands =
    mypy py_github_analyzer

[testenv:security]
deps =
    bandit>=1.7.0
    safety>=2.3.0

commands =
    bandit -r py_github_analyzer -f json -o bandit-report.json
    bandit -r py_github_analyzer
    safety check --json --output safety-report.json
    safety check

[testenv:docs]
deps =
    sphinx>=7.0.0
    sphinx-rtd-theme>=1.3.0
    sphinx-autodoc-typehints>=1.24.0

commands =
    sphinx-build -W -b html docs docs/_build/html

[testenv:docs-serve]
deps =
    {[testenv:docs]deps}

commands =
    sphinx-build -W -b html docs docs/_build/html
    python -m http.server 8000 --directory docs/_build/html

[testenv:clean]
deps =
commands =
    python -c "import shutil; import os; [shutil.rmtree(d, ignore_errors=True) for d in ['.coverage', 'htmlcov', '.pytest_cache', '.mypy_cache', 'build', 'dist', '*.egg-info']]"

[flake8]
max-line-length = 100
extend-ignore = 
    E203,  # whitespace before ':'
    W503,  # line break before binary operator
    E501,  # line too long (handled by black)
    D100,  # Missing docstring in public module
    D104,  # Missing docstring in public package

per-file-ignores =
    tests/*:D100,D101,D102,D103,D104
    __init__.py:D104

docstring-convention = numpy
